name: Build Native Windows Wheels

on:
  push:
    branches: [ main ]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      enable_arrow:
        description: 'Set to "true" to build Arrow-enabled wheel (slower).'
        required: false
        default: 'false'

jobs:
  build-wheels-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    env:
      VCPKG_ROOT: C:\\vcpkg
      BUILD_DIR: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Ensure pip is available
        run: |
          Write-Host "Checking pip..."
          python -m ensurepip --upgrade || Write-Host "ensurepip not available"
          python -m pip --version || python -m pip install --upgrade pip

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ matrix.python-version }}-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            pip-${{ matrix.python-version }}-${{ runner.os }}-

      - name: Install build deps
        run: |
          python -m pip install -U pip setuptools wheel cmake ninja scikit-build-core
          python -m pip install -U build

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            C:\\vcpkg\\downloads
            C:\\vcpkg\\buildtrees
            C:\\vcpkg\\packages
          key: vcpkg-${{ runner.os }}-v1
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Bootstrap vcpkg
        run: |
          if (!(Test-Path $env:VCPKG_ROOT)) { git clone https://github.com/microsoft/vcpkg.git $env:VCPKG_ROOT }
          Push-Location $env:VCPKG_ROOT
          .\bootstrap-vcpkg.bat
          Pop-Location

      - name: Install vcpkg ports (optional Arrow)
        if: ${{ inputs.enable_arrow == 'true' }}
        run: |
          Push-Location $env:VCPKG_ROOT
          .\vcpkg.exe install thrift:x64-windows-static
          .\vcpkg.exe install arrow:x64-windows-static
          Pop-Location

      - name: Build wheel (auto-detect project dir)
        run: |
          Write-Host "Building wheel for Python ${{ matrix.python-version }} (enable_arrow=${{ inputs.enable_arrow }})"
          # Diagnostics: show current directory and files to help CI debugging
          Write-Host "Runner working directory:"; pwd
          Write-Host "Top-level listing:"; Get-ChildItem -Force | ForEach-Object { Write-Host $_.Name }

          # Try to locate pyproject.toml anywhere in the checkout
          Write-Host "Searching for pyproject.toml under the workspace..."
          $proj = Get-ChildItem -Path $PWD -Recurse -Filter pyproject.toml -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($proj) {
            Write-Host "Found pyproject.toml at: $($proj.FullName)"
            $projDir = Split-Path $proj.FullName -Parent
            Write-Host "Using project directory: $projDir"
            Push-Location $projDir
          } elseif (Test-Path ./arbitrex/pyproject.toml) {
            Write-Host "Found ./arbitrex/pyproject.toml; using ./arbitrex"
            Push-Location ./arbitrex
          } elseif (Test-Path ./pyproject.toml) {
            Write-Host "Found ./pyproject.toml at repo root; using repo root"
            Push-Location ./
          } else {
            Write-Host "No pyproject.toml found by search. Checking known locations..."
            if (Test-Path ./arbitrex/pyproject.toml) {
              Write-Host "Found ./arbitrex/pyproject.toml via fallback check; using ./arbitrex"
              Push-Location ./arbitrex
              $builtViaFallback = $true
            } elseif (Test-Path ./pyproject.toml) {
              Write-Host "Found ./pyproject.toml at repo root via fallback check; using repo root"
              Push-Location ./
              $builtViaFallback = $true
            } else {
              Write-Host "No pyproject.toml found anywhere. Will attempt explicit build targeting ./arbitrex as a last-resort fallback."
              $builtViaFallback = $false
            }
          }

          Write-Host "Working now in:"; pwd
          Write-Host "Show (first 200 chars) of pyproject.toml:"; if (Test-Path pyproject.toml) { Get-Content pyproject.toml -Raw | Select-Object -First 200 | ForEach-Object { Write-Host $_ } }

          # Use python -m build which works with PEP517 backends (scikit-build-core)
          python -m pip install --upgrade build
          if ('${{ inputs.enable_arrow }}' -eq 'true') {
            # Ensure vcpkg toolchain is known to CMake via environment variable
            $vc = "$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"
            $env:CMAKE_ARGS = "-DBUILD_ARROW=ON -DCMAKE_TOOLCHAIN_FILE='$vc'"
          } else {
            $env:CMAKE_ARGS = "-DBUILD_ARROW=OFF"
          }

          # Build wheel into dist/ (explicitly pass current directory to avoid ambiguous source detection)
          if ($builtViaFallback -eq $false) {
            Write-Host "Attempting explicit build targeting ./arbitrex (fallback)"
            python -m build -w ./arbitrex
          } else {
            python -m build -w .
            Pop-Location
          }

      - name: Package wheel assets (per Python version)
        working-directory: ./
        run: |
          Write-Host "Packaging wheels for Python ${{ matrix.python-version }}"
          Push-Location ./arbitrex/dist
          $zipName = "arbitrex-${{ matrix.python-version }}.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path * -DestinationPath $zipName
          Pop-Location

      - name: Upload packaged artifact (per Python version)
        uses: actions/upload-artifact@v4
        with:
          name: arbitrex-wheels-py${{ matrix.python-version }}
          path: ./arbitrex/dist/arbitrex-${{ matrix.python-version }}.zip

      - name: Create GitHub Release (on tag)
        id: create_release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload packaged wheel asset to Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $upload_url = '${{ steps.create_release.outputs.upload_url }}'
          # remove templated part
          $base = $upload_url -replace '\{\?name,label\}',''
          $asset_path = "${{ github.workspace }}\arbitrex\dist\arbitrex-${{ matrix.python-version }}.zip"
          $asset_name = "arbitrex-wheels-py${{ matrix.python-version }}.zip"
          $uri = "$base?name=$asset_name"
          Write-Host "Uploading $asset_path to $uri"
          # Use curl (available on GitHub runners) to upload binary asset
          curl -sS -X POST -H "Authorization: token $env:GITHUB_TOKEN" -H "Content-Type: application/zip" --data-binary "@$asset_path" "$uri"
